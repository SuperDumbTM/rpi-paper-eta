{% from "macros/render_field.jinja" import render_field %}

{% extends "layout.jinja" %}
{% include "includes/navbar.jinja" %}

{% block style %}
<style>
    .select-box {
        border-radius: 5px;
        border: var(--bs-border-width) solid var(--bs-border-color);
        padding: 20px;
        height: 400px;
    }
</style>
{% endblock style %}

{% block content %}
<div class="row align-items-center" style="height: 100vh;">
    <div class="mx-auto col-10 col-md-8 col-lg-6">
        <form class="form" action="{{ url_for('api_config.update_epaper_setting') }}" method="post" autocomplete="off">

            <h1>{{ _('display_setting') }}</h1>
            <p class="description">
                {{ _('display_setting_help') }}
            </p>

            <div class="form-group">
                <label for="layout" class="form-label">{{ _('brand') }}</label>
                <select class="form-select" name="epd_brand" required>
                    <option value="" selected>-----</option>
                    {% for brand in brands %}
                    {% if form.epd_brand == brand %}
                    <option value="{{ brand }}" selected>
                        {{ brand | title }}
                    </option>
                    {% else %}
                    <option value="{{ brand }}">
                        {{ brand | title }}
                    </option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="layout" class="form-label">{{ _('model') }}</label>
                <select class="form-select" name="epd_model">
                    <option selected>-----</option>
                    {% for model in models %}
                    {% if form.epd_model == model %}
                    <option value="{{ model }}" selected>
                        {{ model | title }}
                    </option>
                    {% else %}
                    <option value="{{ model }}">
                        {{ model | title }}
                    </option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>

            <input class="btn btn-primary btn-customized mt-4" id="submit" name="submit" type="submit" value="{{ _('submit') }}">

        </form>
    </div>
</div>

{% endblock content %}

{% block script %}
<script>
    $("select[name=epd_brand]").change(function (e) {
        const BRAND = $("select[name=epd_brand]").children("option:selected").val()
        $("select[name=model]").find('option').not(':first').remove()

        if (!BRAND) return
        $.get(`{{ url_for("api_display.get_models") }}?${$.param({ epd_brand: BRAND })}`, function (res) {
            if (res.success) {
                res.data.models.forEach(function (e) {
                    $("select[name=epd_model]").append(new Option(e, e))
                })
            } else {

            }
        })
    })

    $('form').submit(function (e) {
        e.preventDefault()

        $.ajax({
            url: $(this).attr('action'),
            type: $(this).attr('method'),
            data: JSON.stringify(formToJson($(this))),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            error: function (xhr, status, error) {
                alertify.error("{{ _('alert_server_error') }}")
                alertify.error($.parseJSON(xhr.responseText).message)
            },
            success: function (res) {
                if (res.success) {
                    alertify.success("{{ _('updated') }}")
                } else {
                    alertify.error(res.message)
                }
            }
        })
    })
</script>
{% endblock script %}