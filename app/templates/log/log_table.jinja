{% extends "layout.jinja" %}
{% include "includes/navbar.jinja" %}

{% block link %}
<link rel="stylesheet" href="//cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="//cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
{% endblock link %}

{% block content %}
<div class="container-xxl">
    <div class="row p-2">
        <div class="col-12">
            <div class="form-group search-filter">
                <label class="col-sm-2 col-12 col-form-label">{{ _('log_level') }}</label>

                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="log_level" value="DEBUG" checked>
                    <label class="form-check-label">Debug</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="log_level" value="INFO" checked>
                    <label class="form-check-label">Info</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="log_level" value="WARN" checked>
                    <label class="form-check-label">Warning</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="log_level" value="ERROR" checked>
                    <label class="form-check-label">Error</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="log_level" value="CRITICAL" checked>
                    <label class="form-check-label">Critical</label>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="form-group search-filter">
                <label class="col-sm-2 col-6 col-form-label">{{ _('log_request_related') }}</label>

                <div class="form-check form-check-inline form-switch">
                    <input class="form-check-input" type="checkbox" name="request_related" checked>
                    <label class="form-check-label">&nbsp;</label>
                </div>
                <div class="form-text text-mute">
                    {{ _('log_request_related_help') }}
                </div>
            </div>
        </div>
    </div>
    <hr>
    <div class="row p-2">
        <div class="col">
            <table id="log-viewer" class="table table-striped" style="width:100%">
                <thead>
                    <tr>
                        <th class="not-mobile">{{ _('log_timestamp') }}</th>
                        <th class="all">{{ _('log_level') }}</th>
                        <th class="not-mobile">{{ _('log_module') }}</th>
                        <th class="all">{{ _('log_message') }}</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>
{% endblock content %}

{% block script %}
<script src="//cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="//cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="//cdn.datatables.net/buttons/1.7.1/js/dataTables.buttons.min.js"></script>
<script src="//cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="{{ url_for('static', filename='scripts/datatable.js') }}"></script>

<script>

    $(document).ready(function () {
        $.fn.dataTable.ext.search.push(
            // level filter
            function (settings, searchData, index, rowData, counter) {
                let levels = $('input:checkbox[name="log_level"]:checked').map(function () {
                    return this.value
                }).get()

                return levels.indexOf(rowData.level) !== -1
            }
        )

        $.fn.dataTable.ext.search.push(
            // requests related filter
            function (settings, searchData, index, rowData, counter) {
                const modules = ['werkzeug', 'gunicorn', 'uwsgi', 'gevent', 'waitress', 'eventlet']
                let should_incl = $('input:checkbox[name="request_related"]').is(':checked')

                return should_incl || !modules.some(el => rowData.module.includes(el))
            }
        )
    })

    let datatable = $('#log-viewer').DataTable({
        responsive: true,
        ajax: {
            url: "{{ url_for('api_log.get') }}",
            dataSrc: "data.logs",
            beforeSend: showLoading,
            complete: hideLoading
        },
        order: [[0, 'desc']],
        pageLength: 25,
        columns: [
            { data: 'timestamp' },
            {
                data: 'level',
                render: function (data, type, row, meta) {
                    class_ = {
                        DEBUG: 'badge bg-secondary',
                        INFO: 'badge bg-success',
                        WARNING: 'badge bg-warning',
                        ERROR: 'badge bg-danger',
                        CRITICAL: 'badge border border-2 border-danger rounded text-danger'
                    }
                    return `
                        <span class="${class_[data]}">
                            ${data}
                        </span>
                    `
                }
            },
            {
                data: 'module',
                class: 'text-wrap',
            },
            { data: 'message' },
        ],
        dom: `<'row'<'col-sm-12 col-md-6 my-2 my-2'B>>
                <'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>
                <'row'<'col-sm-12'tr>>
                <'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>`,
        buttons: [
            {
                text: "{{ _('download') }}",
                className: "btn btn-info",
                action: function (e, dt, node, config) {
                    window.location.assign("{{ url_for('log.download') }}")
                }
            }
        ]
    });

    $('.search-filter input:checkbox').change(function (e) {
        datatable.draw()
    })

</script>
{% endblock script %}