{% from "macros/render_field.jinja" import render_field %}

{% extends "layout.jinja" %}

{% block link %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
{% endblock link %}

{% block nav %}
{% include "includes/navbar.jinja" %}
{% endblock nav %}


{% block content %}

<div class="row align-items-center" style="height: 100vh;">
    <div class="mx-auto col-10 col-md-8 col-lg-6">
        <form action="{{ form_action }}" method="{{ 'POST' if editing else 'POST' }}" autocomplete="off">
            {{ form.csrf_token }}

            <h1>{{ _('new_bookmark') }}</h1>
            <small class="form-text text-mute">
                {{ _('new_bookmark_help') | safe }}
            </small>

            {% include "includes/flash_success.jinja" %}
            {% include "includes/flash_error.jinja" %}

            <div class="row g-3">
                <div class="col-5">
                    <div class="form-group">
                        {{ form.locale.label(class="form-label") }}
                        {{ form.locale(class="form-select" + form_valid_class(form.locale)) }}
                        <div class="invalid-feedback">
                            {% for error in form.locale.errors %}
                            <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="col-7">
                    <div class="form-group">
                        {{ form.transport.label(class="form-label") }}
                        {{ form.transport(class="form-select" + form_valid_class(form.transport), **{
                        "hx-ext": "path-params",
                        "hx-get": url_for("bookmark.routes", transport="{transport}") | unquote,
                        "hx-trigger": "change" if editing else "load, change",
                        "hx-target": "#nos",
                        "hx-on::before-request": "showLoading()",
                        "hx-on::after-request": "setTimeout(hideLoading, 250)",
                        }) }}
                        <div class="invalid-feedback">
                            {% for error in form.transport.errors %}
                            <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <hr class="mt-4 mb-3">

            <div id="nos">
                {% if edit %}
                {# height placeholder to avoid position shift #}
                <div class="row align-items-center justify-content-center" style="height: 102px;">
                    <div class="loader-ellipsis"></div>
                </div>
                {% else %}
                {% include "bookmark/partials/no_input.jinja" %}
                {% endif %}
            </div>

            <div id="options" hx-ext="path-params"
                hx-include="select[name=locale], select[name=transport], input[name=no]">
                {% if edit %}
                {# height placeholder to avoid position shift #}
                <div class="d-none d-sm-block">
                    <div style="height: 168px;">
                        <div class="row align-items-center justify-content-center" style="height: 102px;">
                            <div class="loader-ellipsis"></div>
                        </div>
                    </div>
                </div>
                <div class="d-block d-sm-none">
                    <div style="height: 266px;">
                        <div class="row align-items-center justify-content-center" style="height: 102px;">
                            <div class="loader-ellipsis"></div>
                        </div>
                    </div>
                </div>
                {% else %}
                {% include "bookmark/partials/options.jinja" %}
                {% endif %}
            </div>

            <div class="form-group text-end pt-3">
                {{ form.submit(class="btn btn-primary btn-customized") }}
            </div>

        </form>
    </div>
</div>
{% endblock content %}

{% block script %}
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

<script>

    var choices;

    {% if editing %}
    choices = new Choices('select[name=no]', {
        allowHTML: false, // suppress warn msg
        maxItemCount: 1
    });
    {% else %}
    document.addEventListener("htmx:afterOnLoad", function (event) {
        if (event.target.id == "transport") {
            choices = new Choices('select[name=no]', {
                allowHTML: false, // suppress warn msg
                maxItemCount: 1
            });
        }
    })
    {% endif %}


</script>
{% endblock script %}